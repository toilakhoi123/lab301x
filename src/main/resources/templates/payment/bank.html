<!doctype html>
<html class="no-js" lang="zxx">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Campaign | Little Hearts, Big Dreams.</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="site.webmanifest">
    <link rel="shortcut icon" type="image/x-icon" href="assets/img/favicon.ico">

    <!-- CSS here -->
	<link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
	<link rel="stylesheet" th:href="@{/assets/css/owl.carousel.min.css}">
	<link rel="stylesheet" th:href="@{/assets/css/slicknav.css}">
    <link rel="stylesheet" th:href="@{/assets/css/flaticon.css}">
    <link rel="stylesheet" th:href="@{/assets/css/progressbar_barfiller.css}">
    <link rel="stylesheet" th:href="@{/assets/css/gijgo.css}">
    <link rel="stylesheet" th:href="@{/assets/css/animate.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/animated-headline.css}">
	<link rel="stylesheet" th:href="@{/assets/css/magnific-popup.css}">
	<link rel="stylesheet" th:href="@{/assets/css/fontawesome-all.min.css}">
	<link rel="stylesheet" th:href="@{/assets/css/themify-icons.css}">
	<link rel="stylesheet" th:href="@{/assets/css/slick.css}">
	<link rel="stylesheet" th:href="@{/assets/css/nice-select.css}">
	<link rel="stylesheet" th:href="@{/assets/css/style.css}">
</head>
<body>
    <!-- preloader -->
    <div th:insert="~{fragment.preloader :: preloader}"></div>
    
    <!-- header -->
    <div th:insert="~{fragment.header :: mainHeader}"></div>

    <!-- main content -->
    <main>
        <!-- Hero section -->
        <div class="slider-area2">
            <div class="slider-height2 d-flex align-items-center">
                <div class="container">
                    <div class="row">
                        <div class="col-xl-12">
                            <div class="hero-cap hero-cap2 pt-20 text-center">
                                <h2 th:text="'Donate to &quot;' + ${campaign.getName()} + '&quot;'">Donate to Campaign</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Donation Info Container -->
        <div style="background-color: #09cc7f; width: 100%; padding: 50px 0;">
            <div class="container my-5">
                <div class="row justify-content-center align-items-center" style="background-color: #f8f9fa; border-radius: 15px; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 30px;">
                    <!-- Left: QR Image -->
                    <div class="col-md-6 text-center mb-4 mb-md-0">
                        <img th:src="${qr}" alt="QR Code" class="img-fluid" 
                            style="max-width: 300px; border: 5px solid #ffffff; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    </div>
    
                    <!-- Right: Bank Information -->
                    <div class="col-md-6">
                        <p><strong>Số tài khoản:</strong> <span th:text="${bankAccountNumber}">123456789</span></p>
                        <p><strong>Ngân hàng:</strong> (<span th:text="${bankName}">Bank name</span>) <span th:text="${bankFullName}">Full bank name</span></p>
                        <p><strong>Tên chủ tài khoản:</strong> <span th:text="${bankAccountOwner}">Nguyen Van A</span></p>
                        <p><strong>Nội dung chuyển khoản:</strong> <span th:text="${description}">Quyen gop MASOQUYENGOP</span></p>
    
                        <!-- Store campaign id in hidden input for scripts if needed -->
                        <input type="hidden" id="campaignId" th:value="${campaign.getId()}">
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-wrapper" style="background-color: #1f1f1f;">
            <!-- Footer Top-->
            <div class="footer-area footer-padding">
                <div class="container">
                    <div class="row d-flex justify-content-between">
                        <div class="col-xl-3 col-lg-3 col-md-4 col-sm-6">
                        <div class="single-footer-caption mb-50">
                            <div class="single-footer-caption mb-30">
                                <div class="footer-tittle">
                                    <div class="footer-logo mb-20">
                                        <a href="index"><img th:src="@{/assets/img/logo/logo2_footer.png}" alt=""></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                        <div class="col-xl-3 col-lg-3 col-md-4 col-sm-5">
                            <div class="single-footer-caption mb-50">
                                <div class="footer-tittle">
                                    <h4>Contact Info</h4>
                                    <ul>
                                        <li>
                                            <p>Address: Gia Lam, Ha Noi, Viet Nam</p>
                                        </li>
                                        <li><a href="tel:+84793300359">Phone: +84 793 300 359</a></li>
                                        <li><a href="mailto:leqwoi@protonmail.com">Email: leqwoi@protonmail.com</a></li>
                                    </ul>
                                </div>

                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-3 col-md-4 col-sm-5">
                            <div class="single-footer-caption mb-50">
                                <div class="footer-tittle">
                                    <h4>Important Links</h4>
                                    <ul>
                                        <li><a href="/about">About Us</a></li>
                                        <li><a href="/contact">Contact Us</a></li>
                                        <li><a href="/index#testimonial">Testimonial</a></li>
                                        <li><a href="/campaigns">Campaigns</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-3 col-md-4 col-sm-5">
                            <div class="single-footer-caption mb-50">
                                <div class="footer-tittle">
                                    <h4>Newsletter</h4>
                                    <div class="footer-pera footer-pera2">
                                    <p>Subscribe to our newsletter to receive campaign updates!</p>
                                </div>
                                <!-- Form -->
                                <div class="footer-form" >
                                    <div id="mc_embed_signup">
                                        <form target="_blank" action="https://spondonit.us12.list-manage.com/subscribe/post?u=1462626880ade1ac87bd9c93a&amp;id=92a4423d01"
                                        method="get" class="subscribe_form relative mail_part">
                                            <input type="email" name="email" id="newsletter-form-email" placeholder="Email Address"
                                            class="placeholder hide-on-focus" onfocus="this.placeholder = ''"
                                            onblur="this.placeholder = ' Email Address '">
                                            <div class="form-icon">
                                                <button type="submit" name="submit" id="newsletter-submit"
                                                class="email_icon newsletter-submit button-contactForm"><img th:src="@{/assets/img/gallery/form.png}" alt=""></button>
                                            </div>
                                            <div class="mt-10 info"></div>
                                        </form>
                                    </div>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- footer-bottom -->
            <div class="footer-bottom-area">
                <div class="container">
                    <div class="footer-border">
                        <div class="row d-flex justify-content-between align-items-center">
                            <div class="col-xl-10 col-lg-9 ">
                                <div class="footer-copy-right">
                                    <p><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
  Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | This template is made with <i class="fa fa-heart" aria-hidden="true"></i> by <a href="https://colorlib.com" target="_blank">Colorlib</a>
  <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. --></p>
                                </div>
                            </div>
                            <div class="col-xl-2 col-lg-3">
                                <div class="footer-social f-right">
                                    <a href="https://web.facebook.com/ffhyme/"><i class="fab fa-facebook-f"></i></a>
                                    <a href="https://leqwoi2.vercel.app/"><i class="fas fa-globe"></i></a>
                                    <a href="https://www.instagram.com/leqwoi/"><i class="fab fa-instagram"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- To top button -->
    <div id="back-top" >
        <a title="Go to Top" href="#"> <i class="fas fa-level-up-alt"></i></a>
    </div>

    <!-- JS here -->

    <script th:src="@{/assets/js/vendor/modernizr-3.5.0.min.js}"></script>
    <!-- Jquery, Popper, Bootstrap -->
    <script th:src="@{/assets/js/vendor/jquery-1.12.4.min.js}"></script>
    <script th:src="@{/assets/js/popper.min.js}"></script>
    <script th:src="@{/assets/js/bootstrap.min.js}"></script>
    <!-- Jquery Mobile Menu -->
    <script th:src="@{/assets/js/jquery.slicknav.min.js}"></script>

    <!-- Jquery Slick , Owl-Carousel Plugins -->
    <script th:src="@{/assets/js/owl.carousel.min.js}"></script>
    <script th:src="@{/assets/js/slick.min.js}"></script>
    <!-- One Page, Animated-HeadLin -->
    <script th:src="@{/assets/js/wow.min.js}"></script>
    <script th:src="@{/assets/js/animated.headline.js}"></script>
    <script th:src="@{/assets/js/jquery.magnific-popup.js}"></script>

    <!-- Date Picker -->
    <script th:src="@{/assets/js/gijgo.min.js}"></script>
    <!-- Nice-select, sticky -->
    <script th:src="@{/assets/js/jquery.nice-select.min.js}"></script>
    <script th:src="@{/assets/js/jquery.sticky.js}"></script>
    <!-- Progress -->
    <script th:src="@{/assets/js/jquery.barfiller.js}"></script>
    
    <!-- counter , waypoint,Hover Direction -->
    <script th:src="@{/assets/js/jquery.counterup.min.js}"></script>
    <script th:src="@{/assets/js/waypoints.min.js}"></script>
    <script th:src="@{/assets/js/jquery.countdown.min.js}"></script>
    <script th:src="@{/assets/js/hover-direction-snake.min.js}"></script>

    <!-- contact js -->
    <script th:src="@{/assets/js/contact.js}"></script>
    <script th:src="@{/assets/js/jquery.form.js}"></script>
    <script th:src="@{/assets/js/jquery.validate.min.js}"></script>
    <script th:src="@{/assets/js/mail-script.js}"></script>
    <script th:src="@{/assets/js/jquery.ajaxchimp.min.js}"></script>
    
    <!-- Jquery Plugins, main Jquery -->	
    <script th:src="@{/assets/js/plugins.js}"></script>
    <script th:src="@{/assets/js/main.js}"></script>

    <!-- transaction check script -->
    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function() {
            const bankAccountNumber = /*[[${bankAccountNumber}]]*/ '123456789';
            const description = /*[[${description}]]*/ 'QUYEN GOP ABCDEFGH';
            const campaignId = /*[[${campaign.getId()}]]*/ '1';
            const code = /*[[${code}]]*/ 'ABCDEFGH';
            const sepayAPIToken = /*[[${sepayAPIToken}]]*/ 'abc';
            const accountId = /*[[${session.account != null ? session.account.getId() : -1}]]*/ -1;
            const amount = /*[[${amount}]]*/

            function checkTransactions() {
                fetch(`/api/sepay/transactions?accountNumber=${bankAccountNumber}&token=${sepayAPIToken}`, {
                    method: 'GET'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 200 && data.transactions) {
                        for (const transaction of data.transactions) {
                            const amountReceived = transaction.amount_in;

                            // Send POST to /campaigns/donate
                            if (
                                transaction.transaction_content 
                                && transaction.transaction_content.includes(description)
                                && Math.round(amount) == Math.round(amountReceived)
                            ) {
                                fetch('/campaigns/donate', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        campaignId: campaignId,
                                        accountId: accountId,
                                        amount: Math.round(amountReceived),
                                        code: code
                                    })
                                })
                                .then(resp => {
                                    if (!resp.ok) {
                                        throw new Error("Donation POST failed");
                                    }
                                    window.location.href = '/account';
                                })
                                .catch(error => {
                                    console.error("Error posting donation:", error);
                                });

                                return; // exit loop after posting donation
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error("Error fetching transactions:", error);
                });
            }

            checkTransactions();
            setInterval(checkTransactions, 10000);
        });
    </script>
</body>
</html>

<!doctype html>
<html class="no-js" lang="zxx">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Account | Little Hearts, Big Dreams.</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="site.webmanifest">
    <link rel="shortcut icon" type="image/x-icon" href="assets/img/favicon.ico">

    <!-- CSS here -->
    <link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/owl.carousel.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/slicknav.css}">
    <link rel="stylesheet" th:href="@{/assets/css/flaticon.css}">
    <link rel="stylesheet" th:href="@{/assets/css/progressbar_barfiller.css}">
    <link rel="stylesheet" th:href="@{/assets/css/gijgo.css}">
    <link rel="stylesheet" th:href="@{/assets/css/animate.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/animated-headline.css}">
    <link rel="stylesheet" th:href="@{/assets/css/magnific-popup.css}">
    <link rel="stylesheet" th:href="@{/assets/css/fontawesome-all.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/themify-icons.css}">
    <link rel="stylesheet" th:href="@{/assets/css/slick.css}">
    <link rel="stylesheet" th:href="@{/assets/css/nice-select.css}">
    <link rel="stylesheet" th:href="@{/assets/css/style.css}">

    <!-- Custom CSS for equal height and scrolling -->
    <style>
        .equal-height-container {
            display: flex;
            flex-wrap: wrap;
            align-items: stretch;
        }

        .equal-height-card {
            height: 355px;
            display: flex;
            flex-direction: column;
        }

        .scrollable-content {
            flex-grow: 1;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- preloader -->
    <div th:insert="~{fragment.preloader :: preloader}"></div>
    
    <!-- header -->
    <div th:insert="~{fragment.header :: mainHeader}"></div>

    <!-- main content -->
    <main>
        <!-- Hero Start -->
        <div class="slider-area2">
            <div class="slider-height2 d-flex align-items-center">
                <div class="container">
                    <div class="row">
                        <div class="col-xl-12">
                            <div class="hero-cap hero-cap2 pt-20 text-center">
                                <h2 th:text="${account.getFullName()} + '’s Profile'">Account Details</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Details and Followed Campaigns -->
        <div class="container my-5">
            <div class="row equal-height-container">
                <!-- Left: Account Info -->
                <div class="col-lg-6 mb-4">
                    <div class="equal-height-card">
                        <h3 class="mb-3"><strong>Thông tin tài khoản</strong></h3>
                        <div class="border rounded p-4 shadow-sm">
                            <div class="scrollable-content">
                                <p><strong>Họ tên:</strong> <span th:text="${account.getFullName()}">Full Name</span></p>
                                <p><strong>Email:</strong> <span th:text="${account.getEmail()}">email@example.com</span></p>
                                <p><strong>Số điện thoại:</strong> <span th:text="${account.getPhoneNumber()}">0123456789</span></p>
                                <p><strong>Vai trò:</strong> <span th:text="${account.role.roleName}"></span></p>
                                <p><strong>Lần đăng nhập gần nhất:</strong> <span th:text="${#dates.format(account.getLastLoginDate(), 'dd MMM yyyy')}">01 Jan 2025 12:00</span></p>
                            </div>
                            <!-- Buttons -->
                            <div class="d-flex justify-content-between mt-4" th:if="${(session.account != null and session.account.getId() == account.getId()) or userPermissionService.hasPermission(session.account, T(com.khoi.lab.enums.UserPermission).MANAGE_USERS)}">
                                <a href="/edit-account" class="btn btn-success">Edit</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Followed Campaigns -->
                <div class="col-lg-6 mb-4" th:if="${session.account.id == account.id or userPermissionService.hasPermission(session.account, T(com.khoi.lab.enums.UserPermission).MANAGE_USERS)}">
                    <div class="equal-height-card">
                        <h3 class="mb-3"><strong>Chiến dịch đang theo dõi</strong></h3>
                        <div class="scrollable-content border rounded p-4 shadow-sm">
                            <div th:if="${#lists.isEmpty(account.getFollowedCampaigns())}" class="text-muted mt-2 text-center">
                                Bạn chưa theo dõi chiến dịch nào.
                            </div>
                            <div th:each="campaign : ${account.getFollowedCampaigns()}" class="d-flex align-items-center mb-3 p-3 border rounded">
                                <!-- Campaign Image -->
                                <img th:src="@{${campaign.imageUrl}}" alt="Campaign Image" style="width: 80px; height: 80px; object-fit: cover;" class="rounded-lg mr-4">

                                <!-- Campaign Details -->
                                <div class="flex-grow-1">
                                    <h5 class="mb-1">
                                        <a th:href="@{/campaigns/campaign(id=${campaign.getId()})}" th:text="${campaign.getName()}" class="font-bold">Campaign Name</a>
                                    </h5>
                                    <h6 class="mb-1">
                                        <strong>Đã quyên góp:</strong> <span th:text="${campaign.getDonatedPercentageCapped()}"></span>%<br>
                                        <strong>Kết thúc:</strong> <span th:text="${#temporals.format(campaign.getEndTime(), 'HH:mm dd MMM yyyy')}"></span>
                                    </h6>
                                </div>

                                <!-- Notification Bell Icon -->
                                <div class="d-flex flex-column align-items-center ml-4">
                                    <a href="#" 
                                       th:attr="data-campaign-id=${campaign.getId()}" 
                                       class="notification-toggle-icon">
                                        <i th:classappend="${account.isCampaignIdEnableNotifications(campaign.id)} ? 'fas fa-bell' : 'far fa-bell'" 
                                           style="font-size: 1.5rem; cursor: pointer; color: #1dc88a;"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Custom script for notification toggle -->
                <script>
                    document.querySelectorAll('.notification-toggle-icon').forEach(icon => {
                        icon.addEventListener('click', function(event) {
                            event.preventDefault(); // Prevent the default link behavior
                            
                            const campaignId = this.getAttribute('data-campaign-id');
                            const bellIcon = this.querySelector('i');
                            const isCurrentlyEnabled = bellIcon.classList.contains('fas');
                            
                            // Toggle the icon's appearance immediately for a responsive feel
                            if (isCurrentlyEnabled) {
                                bellIcon.classList.remove('fas', 'fa-bell');
                                bellIcon.classList.add('far', 'fa-bell');
                            } else {
                                bellIcon.classList.remove('far', 'fa-bell');
                                bellIcon.classList.add('fas', 'fa-bell');
                            }

                            // Make the API call to update the state on the server
                            fetch(`/campaigns/campaign/notifications?id=${campaignId}`, {
                                method: 'GET'
                            })
                            .then(response => {
                                if (!response.ok) {
                                    // If the server returns an error, revert the icon state
                                    console.error('Failed to update notification state:', response.statusText);
                                    if (isCurrentlyEnabled) {
                                        bellIcon.classList.remove('far', 'fa-bell');
                                        bellIcon.classList.add('fas', 'fa-bell');
                                    } else {
                                        bellIcon.classList.remove('fas', 'fa-bell');
                                        bellIcon.classList.add('far', 'fa-bell');
                                    }
                                } else {
                                    // The server successfully handled the request. The UI is already updated.
                                    console.log('Notification state updated successfully.');
                                }
                            })
                            .catch(error => {
                                // Handle network errors
                                console.error('Network error during notification update:', error);
                                // Revert the icon state on error
                                if (isCurrentlyEnabled) {
                                    bellIcon.classList.remove('far', 'fa-bell');
                                    bellIcon.classList.add('fas', 'fa-bell');
                                } else {
                                    bellIcon.classList.remove('fas', 'fa-bell');
                                    bellIcon.classList.add('far', 'fa-bell');
                                }
                            });
                        });
                    });
                </script>
            </div>

            <!-- NEW SECTION: Donations -->
            <div class="row mt-5">
                <div class="col-lg-12">
                    <h3><strong>Quyên góp gần đây</strong></h3><br>
                    <div class="border rounded p-4 shadow-sm" style="max-height: 400px; overflow-y: auto;">
                        <div th:if="${#lists.isEmpty(account.getDonations())}" class="text-muted mt-2">
                            Tài khoản này chưa có quyên góp nào.
                        </div>
                        <div th:each="donation : ${account.getDonations()}">
                            <a
                                th:href="@{/campaigns/campaign(id=${donation.getCampaign().getId()})}"
                                th:styleappend="${donation.isConfirmed()} ? 'background-color: #09cc7f; color: white;' : 'background-color: #f8f9fa;'"
                                class="d-flex justify-content-between align-items-center mb-2 px-3 py-2 rounded"
                                style="min-height: 50px;">
                                <!-- left -->
                                <div>
                                    <small class="text-muted" th:text="${donation.getTimeAgo()}">Thời gian</small><br>
                                    <span th:text="!${donation.isConfirmed()} ? '(chưa xác nhận) ' + ${donation.getCampaign().getName()} : ${donation.getCampaign().getName()}" style="color: #1f1f1f;">
                                        Đợt quyên góp
                                    </span>
                                </div>
                                <!-- right -->
                                <span th:text="${#numbers.formatDecimal(donation.getAmount(), 0, 'COMMA', 0, 'POINT') + '₫'}" style="color: #1f1f1f;">Số tiền</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- footer -->
    <div th:insert="~{fragment.footer :: footer}"></div>

    <!-- To top button -->
    <div id="back-top" >
        <a title="Go to Top" href="#"> <i class="fas fa-level-up-alt"></i></a>
    </div>

    <!-- JS here -->
    <script th:src="@{/assets/js/vendor/modernizr-3.5.0.min.js}"></script>
    <!-- Jquery, Popper, Bootstrap -->
    <script th:src="@{/assets/js/vendor/jquery-1.12.4.min.js}"></script>
    <script th:src="@{/assets/js/popper.min.js}"></script>
    <script th:src="@{/assets/js/bootstrap.min.js}"></script>
    <!-- Jquery Mobile Menu -->
    <script th:src="@{/assets/js/jquery.slicknav.min.js}"></script>
    <!-- Jquery Slick , Owl-Carousel Plugins -->
    <script th:src="@{/assets/js/owl.carousel.min.js}"></script>
    <script th:src="@{/assets/js/slick.min.js}"></script>
    <!-- One Page, Animated-HeadLin -->
    <script th:src="@{/assets/js/wow.min.js}"></script>
    <script th:src="@{/assets/js/animated.headline.js}"></script>
    <script th:src="@{/assets/js/jquery.magnific-popup.js}"></script>
    <!-- Date Picker -->
    <script th:src="@{/assets/js/gijgo.min.js}"></script>
    <!-- Nice-select, sticky -->
    <script th:src="@{/assets/js/jquery.nice-select.min.js}"></script>
    <script th:src="@{/assets/js/jquery.sticky.js}"></script>
    <!-- Progress -->
    <script th:src="@{/assets/js/jquery.barfiller.js}"></script>
    <!-- counter , waypoint,Hover Direction -->
    <script th:src="@{/assets/js/jquery.counterup.min.js}"></script>
    <script th:src="@{/assets/js/waypoints.min.js}"></script>
    <script th:src="@{/assets/js/jquery.countdown.min.js}"></script>
    <script th:src="@{/assets/js/hover-direction-snake.min.js}"></script>
    <!-- contact js -->
    <script th:src="@{/assets/js/contact.js}"></script>
    <script th:src="@{/assets/js/jquery.form.js}"></script>
    <script th:src="@{/assets/js/jquery.validate.min.js}"></script>
    <script th:src="@{/assets/js/mail-script.js}"></script>
    <script th:src="@{/assets/js/jquery.ajaxchimp.min.js}"></script>
    <!-- Jquery Plugins, main Jquery -->    
    <script th:src="@{/assets/js/plugins.js}"></script>
    <script th:src="@{/assets/js/main.js}"></script>
</body>
</html>
